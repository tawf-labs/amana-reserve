name: AMANA CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  FOUNDRY_VERSION: latest
  NODE_VERSION: 20.x
  RUST_VERSION: stable

jobs:
  # Ethereum Contracts (Foundry)
  ethereum-lint:
    name: Ethereum Contracts - Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/ethereum
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1
        with:
          version: ${{ env.FOUNDRY_VERSION }}

      - name: Run Forge fmt check
        run: forge fmt --check

      - name: Run Forge lint
        run: forge lint --check

  ethereum-build:
    name: Ethereum Contracts - Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/ethereum
    needs: ethereum-lint
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Build contracts
        run: forge build --sizes

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ethereum-build
          path: packages/ethereum/out

  ethereum-test:
    name: Ethereum Contracts - Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/ethereum
    needs: ethereum-build
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Run tests
        run: forge test -vvv

      - name: Generate coverage
        run: forge coverage --report lcov

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: packages/ethereum/lcov.info
          flags: ethereum

  # Solana Programs (Anchor)
  solana-test:
    name: Solana Programs - Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/solana
    steps:
      - uses: actions/checkout@v4

      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/v1.18/install/install.sh)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Install Anchor
        run: |
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
          avm install latest
          avm use latest

      - name: Build Anchor programs
        run: anchor build

      - name: Run Anchor tests
        run: anchor test --skip-local-validator

  # SDK Tests
  sdk-test:
    name: SDK - Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/sdk
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build SDK
        run: pnpm run build

      - name: Run tests
        run: pnpm run test
        continue-on-error: true

  # Backend Tests
  backend-test:
    name: Backend - Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/backend
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run HAI Aggregator tests
        run: pnpm --filter hai-aggregator run test

      - name: Run Trust Score tests
        run: pnpm --filter trust-score run test

  # Frontend Tests & Build
  frontend-test:
    name: Frontend - Test & Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/frontend
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run lint
        run: pnpm run lint

      - name: Run tests
        run: pnpm run test
        continue-on-error: true

      - name: Build frontend
        run: pnpm run build
        env:
          NODE_ENV: production

  # Integration Tests
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [ethereum-test, sdk-test]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run integration tests
        run: pnpm test:e2e
        continue-on-error: true

  # Security Scans
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run Slither on Ethereum contracts
        uses: crytic/slither-action@v0.3.0
        continue-on-error: true
        with:
          target: packages/ethereum/contracts
          node-id: 16

  # Build Status Check
  build-check:
    name: Build Status Check
    runs-on: ubuntu-latest
    needs: [ethereum-test, solana-test, sdk-test, backend-test, frontend-test]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.ethereum-test.result }}" != "success" ]; then
            echo "Ethereum tests failed"
            exit 1
          fi
          if [ "${{ needs.solana-test.result }}" != "success" ]; then
            echo "Solana tests failed"
            exit 1
          fi
          echo "All critical jobs passed!"
